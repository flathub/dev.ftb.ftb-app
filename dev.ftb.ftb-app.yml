app-id: dev.ftb.ftb-app
base: org.electronjs.Electron2.BaseApp
base-version: '24.08'
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: ftb.sh

finish-args:
  # - --socket=wayland
  # - --socket=fallback-x11
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  - --share=ipc
  - --share=network
  - --filesystem=~/.ftba:create # Home folder for the FTB App
  - --filesystem=xdg-run/app/com.discordapp.Discord:create # Needed for mods that integrate with Discord RPC

  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
  # - --env=ELECTRON_OZONE_PLATFORM_HINT=auto # Use wayland if available

modules:
# Credit to the prism flatpak manifest for the gamemode module
  - name: gamemode
    buildsystem: meson
    config-opts:
      - -Dwith-sd-bus-provider=no-daemon
      - -Dwith-examples=false
    post-install:
      # gamemoderun is installed for users who want to use wrapper commands
      # post-install is running inside the build dir, we need it from the source though
      - install -Dm755 ../data/gamemoderun -t /app/bin
    sources:
      - type: archive
        dest-filename: gamemode.tar.gz
        url: https://api.github.com/repos/FeralInteractive/gamemode/tarball/1.8.2
        sha256: 2886d4ce543c78bd2a364316d5e7fd59ef06b71de63f896b37c6d3dc97658f60
        x-checker-data:
          type: json
          url: https://api.github.com/repos/FeralInteractive/gamemode/releases/latest
          version-query: .tag_name
          url-query: .tarball_url
          timestamp-query: .published_at
    cleanup:
      - /include
      - /lib/pkgconfig
      - /lib/libgamemodeauto.a

  - name: ftb-app
    buildsystem: simple
    build-commands:
      - chmod +x FTB-App-linux-setup.AppImage
      - ./FTB-App-linux-setup.AppImage --appimage-extract
      - cp -r squashfs-root /app/bin/ftb-app
      - install -D icon.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -D ${FLATPAK_ID}.desktop -t /app/share/applications
      - install -D ${FLATPAK_ID}.metainfo.xml -t /app/share/metainfo
      - install -D ftb.sh /app/bin
    sources:
      - type: file
        dest-filename: FTB-App-linux-setup.AppImage
        url: https://piston.feed-the-beast.com/app/ftb-app-linux-1.29.4-beta.291-x86_64.AppImage
        sha512: 7ba2d85f2276af72d1d74c2dd788e96839a79ed20202f4e54d4378b8da64a4b64e930623dbdda0188224893bc646650e4a7f2e46ac6084f9880c9439b194697a
        only-arches:
          - x86_64
        x-checker-data:
          type: electron-updater
          url: https://piston.feed-the-beast.com/app/beta-linux.yml

      - type: file
        dest-filename: FTB-App-linux-setup.AppImage
        url: https://piston.feed-the-beast.com/app/ftb-app-linux-1.29.4-beta.291-arm64.AppImage
        sha512: d902a83f2cdf221919d910101efa818ab850a0bb6c1b196eb5721392dbd1f7f8105fe8ede2a0b5c9ed3c21ed54df6397fe6f181619be6ae5ee082d2fcc097544
        only-arches:
          - aarch64
        x-checker-data:
          type: electron-updater
          url: https://piston.feed-the-beast.com/app/beta-linux-arm64.yml

      - type: file
        url: https://github.com/FTBTeam/FTB-App/raw/main/flathub/dev.ftb.ftb-app.desktop
        sha256: da102a024457d0cf9986f032b3102dbc3f286612fed5dece4bbe83d02af76ef8

      - type: file
        url: https://github.com/FTBTeam/FTB-App/raw/main/resources/icon.png
        sha256: fbdd6af27ba157d308884d2f3831c12c3d1d1464b60d8b08ef76cae8ff30cc4f

      - type: file
        url: https://raw.githubusercontent.com/FTBTeam/FTB-App/main/flathub/dev.ftb.ftb-app.metainfo.xml?version=a4200a4cf505188654e17b9e5f4ffe533e79a2b0
        sha512: b870f37890ce3e0ea21d5fc19d3e95afe2151002f8c7ce4579ce62e9d140ff7c4f00c82f01653b37f69204c4462747d0f3b1804f4c82e4330955c741df6cf8a4
        x-checker-data:
          type: json
          url: https://api.github.com/repos/FTBTeam/FTB-App/contents/flathub/dev.ftb.ftb-app.metainfo.xml
          version-query: .sha
          url-query: '"https://raw.githubusercontent.com/FTBTeam/FTB-App/main/flathub/dev.ftb.ftb-app.metainfo.xml?version=\($version)"'
      - type: script
        commands:
          - |
            # Discord IPC support
            for i in {0..9}; do
              test -S $XDG_RUNTIME_DIR/discord-ipc-$i || ln -sf {app/com.discordapp.Discord,$XDG_RUNTIME_DIR}/discord-ipc-$i;
            done
            export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
            WAYLAND_SOCKET=${WAYLAND_DISPLAY:-"wayland-0"}
            # declare -a FLAGS=()
            # if [[ $XDG_SESSION_TYPE == "wayland" && -z "$DISPLAY" ]]; then
              # if [[ -c /dev/nvidia0 ]]; then
                # echo "Using NVIDIA on wayland, disabling gpu sandbox"
                # FLAGS+=(--disable-gpu-sandbox)
              # fi

              # WAYLAND_SOCKET=${WAYLAND_DISPLAY:-"wayland-0"}
              # if [[ "${WAYLAND_SOCKET:0:1}" != "/" ]]; then
                # WAYLAND_SOCKET="$XDG_RUNTIME_DIR/$WAYLAND_SOCKET"
              # fi

              # echo "Running on native Wayland"
              # FLAGS+=(--ozone-platform-hint=auto)
              # FLAGS+=(--enable-wayland-ime)
              # FLAGS+=(--enable-features=WaylandWindowDecorations)
            # else
              # echo "Running on x11"
            # fi

            # echo "Passing the following flags to electron:" "${FLAGS[@]}" "$@"
            # exec zypak-wrapper /app/bin/ftb-app/ftb-app "${FLAGS[@]}" "$@" --ignore-pid-checks
            rm -f ~/.ftba/app.pid # Temp fix for --ignore-pid-checks not working
            exec zypak-wrapper /app/bin/ftb-app/ftb-app "$@" --ignore-pid-checks
        dest-filename: ftb.sh
